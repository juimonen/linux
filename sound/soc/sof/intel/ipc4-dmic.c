// SPDX-License-Identifier: (GPL-2.0-only OR BSD-3-Clause)
//
// This file is provided under a dual BSD/GPLv2 license.  When using or
// redistributing this file, you may do so under either license.
//
// Copyright(c) 2021 Intel Corporation. All rights reserved.
//
// Authors: Seppo Ingalsuo <seppo.ingalsuo@linux.intel.com>
// Authors: Rander Wang <rander.wang@linux.intel.com>

/* Intel dmic code */

/* Global configuration request for DMIC */
#include <sound/pcm_params.h>
#include <sound/intel-nhlt.h>
#include "../sof-audio.h"
#include "../ipc4-topology.h"
#include "../ipc4.h"
#include "ipc4-i2s.h"
#include "shim.h"
#include "ipc4-dmic.h"
#include "pdm_decim/pdm_decim_table.h"

static uint32_t mtl_2ch_dmic[] = {
	0x00000000, 0xffff3210, 0xffffff10, 0xffffff32, 0xffffffff, 0x00000010, 0x00000003, 0x00210844
	, 0x00210844, 0x00000003, 0x00000001, 0x0b001800, 0x00000000, 0x00000603, 0x00000000, 0x00000000
	, 0x00000000, 0x00000000, 0x00000011, 0x00010074, 0x00000000, 0x00000000, 0x00000000, 0x00000000
	, 0x00000000, 0x00000000, 0x00000011, 0x000502f6, 0x00000000, 0x00000000, 0x00000000, 0x00000000
	, 0x00000000, 0x00000000, 0x000fffcb, 0x000ffefd, 0x000ffdd1, 0x000ffd72, 0x000ffede, 0x000000f2
	, 0x00000146, 0x000fff7f, 0x000ffe76, 0x0000001d, 0x000001e1, 0x00000064, 0x000ffd9f, 0x000ffe89
	, 0x00000268, 0x000002aa, 0x000ffded, 0x000ffbf5, 0x00000127, 0x00000556, 0x0000005c, 0x000ff999
	, 0x000ffd71, 0x000006e5, 0x00000551, 0x000ff976, 0x000ff795, 0x00000519, 0x00000b8e, 0x000ffd95
	, 0x000ff1a8, 0x000ffe68, 0x00001043, 0x000006d7, 0x000fef3a, 0x000ff2ff, 0x00000f60, 0x00001388
	, 0x000ff436, 0x000fe624, 0x000005b9, 0x00001f17, 0x000002b9, 0x000fdd9f, 0x000ff2b9, 0x000022b9
	, 0x00001919, 0x000fe078, 0x000fdab0, 0x00001842, 0x000030b8, 0x000ff363, 0x000fc64d, 0x000ffd10
	, 0x00003eeb, 0x000015a8, 0x000fc0f5, 0x000fd5b3, 0x00003932, 0x00003fc0, 0x000fd417, 0x000fac53
	, 0x00001619, 0x000061a5, 0x00000560, 0x000f9718, 0x000fd9cf, 0x00006644, 0x00004956, 0x000fa7ee
	, 0x000f9495, 0x00003d3d, 0x000087fb, 0x000fe9b6, 0x000f659b, 0x000fe529, 0x00009dec, 0x00005239
	, 0x000f7176, 0x000f75f3, 0x0000698b, 0x0000ba79, 0x000fd136, 0x000f258f, 0x000fe159, 0x0000e07d
	, 0x000077ad, 0x000f3bf6, 0x000f2f4b, 0x00007e97, 0x00011809, 0x000fefae, 0x000ec7da, 0x000f82b8
	, 0x000119da, 0x00011303, 0x000f55eb, 0x000e77b2, 0x000fe4a6, 0x0001a307, 0x00011a3d, 0x000ede66
	, 0x000e01b1, 0x000fdcd5, 0x000228de, 0x0001e9c9, 0x000f3181, 0x000d006f, 0x000dc870, 0x0000f56f
	, 0x0003f255, 0x0004dae6, 0x0003cd30, 0x00021874, 0x0000cf96, 0x0000341e, 0x00000696, 0x00000034
	, 0x00000069, 0x000000c2, 0x00000137, 0x000001c0, 0x0000024c, 0x000002c6, 0x0000030f, 0x0000030e
	, 0x000002ab, 0x000001de, 0x000000af, 0x000fff39, 0x000ffdaa, 0x000ffc40, 0x000ffb3a, 0x000ffad1
	, 0x000ffb27, 0x000ffc41, 0x000ffdfe, 0x00000019, 0x00000231, 0x000003db, 0x000004b3, 0x00000478
	, 0x00000315, 0x000000b5, 0x000ffdbb, 0x000ffab6, 0x000ff84b, 0x000ff70f, 0x000ff76a, 0x000ff978
	, 0x000ffcfc, 0x00000162, 0x000005d6, 0x00000968, 0x00000b3d, 0x00000ac4, 0x000007da, 0x000002dd
	, 0x000ffca8, 0x000ff671, 0x000ff18c, 0x000fef2a, 0x000ff00d, 0x000ff45a, 0x000ffb7b, 0x0000042f
	, 0x00000cc1, 0x00001358, 0x0000165a, 0x000014ce, 0x00000e9d, 0x000004af, 0x000ff8d0, 0x000fed60
	, 0x000fe4df, 0x000fe164, 0x000fe41f, 0x000fed07, 0x000ffabb, 0x00000ab3, 0x000019b1, 0x00002466
	, 0x00002826, 0x0000238e, 0x000016e4, 0x00000437, 0x000fef0a, 0x000fdbb7, 0x000fce8f, 0x000fcaea
	, 0x000fd259, 0x000fe42c, 0x000ffd67, 0x00001936, 0x000031d1, 0x000041a7, 0x00004495, 0x000038e8
	, 0x00001ff2, 0x000ffdf9, 0x000fd991, 0x000fba62, 0x000fa797, 0x000fa64b, 0x000fb845, 0x000fdb4e
	, 0x00000951, 0x00003958, 0x00006134, 0x0000778f, 0x000075ff, 0x00005aa7, 0x00002904, 0x000fe9b1
	, 0x000fa908, 0x000f74e5, 0x000f59d6, 0x000f6059, 0x000f8aa8, 0x000fd39a, 0x00002ef2, 0x00008b23
	, 0x0000d45f, 0x0000f860, 0x0000ea5c, 0x0000a63e, 0x00003296, 0x000fa0b7, 0x000f0ace, 0x000e9032
	, 0x000e5069, 0x000e65b6, 0x000ee017, 0x000fc19f, 0x0000fce4, 0x000275dc, 0x0004052a, 0x00057d62
	, 0x0006b177, 0x00077b59, 0x0007c19e, 0x00077b59, 0x0006b177, 0x00057d62, 0x0004052a, 0x000275dc
	, 0x0000fce4, 0x000fc19f, 0x000ee017, 0x000e65b6, 0x000e5069, 0x000e9032, 0x000f0ace, 0x000fa0b7
	, 0x00003296, 0x0000a63e, 0x0000ea5c, 0x0000f860, 0x0000d45f, 0x00008b23, 0x00002ef2, 0x000fd39a
	, 0x000f8aa8, 0x000f6059, 0x000f59d6, 0x000f74e5, 0x000fa908, 0x000fe9b1, 0x00002904, 0x00005aa7
	, 0x000075ff, 0x0000778f, 0x00006134, 0x00003958, 0x00000951, 0x000fdb4e, 0x000fb845, 0x000fa64b
	, 0x000fa797, 0x000fba62, 0x000fd991, 0x000ffdf9, 0x00001ff2, 0x000038e8, 0x00004495, 0x000041a7
	, 0x000031d1, 0x00001936, 0x000ffd67, 0x000fe42c, 0x000fd259, 0x000fcaea, 0x000fce8f, 0x000fdbb7
	, 0x000fef0a, 0x00000437, 0x000016e4, 0x0000238e, 0x00002826, 0x00002466, 0x000019b1, 0x00000ab3
	, 0x000ffabb, 0x000fed07, 0x000fe41f, 0x000fe164, 0x000fe4df, 0x000fed60, 0x000ff8d0, 0x000004af
	, 0x00000e9d, 0x000014ce, 0x0000165a, 0x00001358, 0x00000cc1, 0x0000042f, 0x000ffb7b, 0x000ff45a
	, 0x000ff00d, 0x000fef2a, 0x000ff18c, 0x000ff671, 0x000ffca8, 0x000002dd, 0x000007da, 0x00000ac4
	, 0x00000b3d, 0x00000968, 0x000005d6, 0x00000162, 0x000ffcfc, 0x000ff978, 0x000ff76a, 0x000ff70f
	, 0x000ff84b, 0x000ffab6, 0x000ffdbb, 0x000000b5, 0x00000315, 0x00000478, 0x000004b3, 0x000003db
	, 0x00000231, 0x00000019, 0x000ffdfe, 0x000ffc41, 0x000ffb27, 0x000ffad1, 0x000ffb3a, 0x000ffc40
	, 0x000ffdaa, 0x000fff39, 0x000000af, 0x000001de, 0x000002ab, 0x0000030e, 0x0000030f, 0x000002c6
	, 0x0000024c, 0x000001c0, 0x00000137, 0x000000c2, 0x00000069, 0x00000034, 0x00000001, 0x0b001800
	, 0x00000000, 0x00000603, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000011, 0x00010074
	, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000011, 0x000502f6
	, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x000fffcb, 0x000ffefd
	, 0x000ffdd1, 0x000ffd72, 0x000ffede, 0x000000f2, 0x00000146, 0x000fff7f, 0x000ffe76, 0x0000001d
	, 0x000001e1, 0x00000064, 0x000ffd9f, 0x000ffe89, 0x00000268, 0x000002aa, 0x000ffded, 0x000ffbf5
	, 0x00000127, 0x00000556, 0x0000005c, 0x000ff999, 0x000ffd71, 0x000006e5, 0x00000551, 0x000ff976
	, 0x000ff795, 0x00000519, 0x00000b8e, 0x000ffd95, 0x000ff1a8, 0x000ffe68, 0x00001043, 0x000006d7
	, 0x000fef3a, 0x000ff2ff, 0x00000f60, 0x00001388, 0x000ff436, 0x000fe624, 0x000005b9, 0x00001f17
	, 0x000002b9, 0x000fdd9f, 0x000ff2b9, 0x000022b9, 0x00001919, 0x000fe078, 0x000fdab0, 0x00001842
	, 0x000030b8, 0x000ff363, 0x000fc64d, 0x000ffd10, 0x00003eeb, 0x000015a8, 0x000fc0f5, 0x000fd5b3
	, 0x00003932, 0x00003fc0, 0x000fd417, 0x000fac53, 0x00001619, 0x000061a5, 0x00000560, 0x000f9718
	, 0x000fd9cf, 0x00006644, 0x00004956, 0x000fa7ee, 0x000f9495, 0x00003d3d, 0x000087fb, 0x000fe9b6
	, 0x000f659b, 0x000fe529, 0x00009dec, 0x00005239, 0x000f7176, 0x000f75f3, 0x0000698b, 0x0000ba79
	, 0x000fd136, 0x000f258f, 0x000fe159, 0x0000e07d, 0x000077ad, 0x000f3bf6, 0x000f2f4b, 0x00007e97
	, 0x00011809, 0x000fefae, 0x000ec7da, 0x000f82b8, 0x000119da, 0x00011303, 0x000f55eb, 0x000e77b2
	, 0x000fe4a6, 0x0001a307, 0x00011a3d, 0x000ede66, 0x000e01b1, 0x000fdcd5, 0x000228de, 0x0001e9c9
	, 0x000f3181, 0x000d006f, 0x000dc870, 0x0000f56f, 0x0003f255, 0x0004dae6, 0x0003cd30, 0x00021874
	, 0x0000cf96, 0x0000341e, 0x00000696, 0x00000034, 0x00000069, 0x000000c2, 0x00000137, 0x000001c0
	, 0x0000024c, 0x000002c6, 0x0000030f, 0x0000030e, 0x000002ab, 0x000001de, 0x000000af, 0x000fff39
	, 0x000ffdaa, 0x000ffc40, 0x000ffb3a, 0x000ffad1, 0x000ffb27, 0x000ffc41, 0x000ffdfe, 0x00000019
	, 0x00000231, 0x000003db, 0x000004b3, 0x00000478, 0x00000315, 0x000000b5, 0x000ffdbb, 0x000ffab6
	, 0x000ff84b, 0x000ff70f, 0x000ff76a, 0x000ff978, 0x000ffcfc, 0x00000162, 0x000005d6, 0x00000968
	, 0x00000b3d, 0x00000ac4, 0x000007da, 0x000002dd, 0x000ffca8, 0x000ff671, 0x000ff18c, 0x000fef2a
	, 0x000ff00d, 0x000ff45a, 0x000ffb7b, 0x0000042f, 0x00000cc1, 0x00001358, 0x0000165a, 0x000014ce
	, 0x00000e9d, 0x000004af, 0x000ff8d0, 0x000fed60, 0x000fe4df, 0x000fe164, 0x000fe41f, 0x000fed07
	, 0x000ffabb, 0x00000ab3, 0x000019b1, 0x00002466, 0x00002826, 0x0000238e, 0x000016e4, 0x00000437
	, 0x000fef0a, 0x000fdbb7, 0x000fce8f, 0x000fcaea, 0x000fd259, 0x000fe42c, 0x000ffd67, 0x00001936
	, 0x000031d1, 0x000041a7, 0x00004495, 0x000038e8, 0x00001ff2, 0x000ffdf9, 0x000fd991, 0x000fba62
	, 0x000fa797, 0x000fa64b, 0x000fb845, 0x000fdb4e, 0x00000951, 0x00003958, 0x00006134, 0x0000778f
	, 0x000075ff, 0x00005aa7, 0x00002904, 0x000fe9b1, 0x000fa908, 0x000f74e5, 0x000f59d6, 0x000f6059
	, 0x000f8aa8, 0x000fd39a, 0x00002ef2, 0x00008b23, 0x0000d45f, 0x0000f860, 0x0000ea5c, 0x0000a63e
	, 0x00003296, 0x000fa0b7, 0x000f0ace, 0x000e9032, 0x000e5069, 0x000e65b6, 0x000ee017, 0x000fc19f
	, 0x0000fce4, 0x000275dc, 0x0004052a, 0x00057d62, 0x0006b177, 0x00077b59, 0x0007c19e, 0x00077b59
	, 0x0006b177, 0x00057d62, 0x0004052a, 0x000275dc, 0x0000fce4, 0x000fc19f, 0x000ee017, 0x000e65b6
	, 0x000e5069, 0x000e9032, 0x000f0ace, 0x000fa0b7, 0x00003296, 0x0000a63e, 0x0000ea5c, 0x0000f860
	, 0x0000d45f, 0x00008b23, 0x00002ef2, 0x000fd39a, 0x000f8aa8, 0x000f6059, 0x000f59d6, 0x000f74e5
	, 0x000fa908, 0x000fe9b1, 0x00002904, 0x00005aa7, 0x000075ff, 0x0000778f, 0x00006134, 0x00003958
	, 0x00000951, 0x000fdb4e, 0x000fb845, 0x000fa64b, 0x000fa797, 0x000fba62, 0x000fd991, 0x000ffdf9
	, 0x00001ff2, 0x000038e8, 0x00004495, 0x000041a7, 0x000031d1, 0x00001936, 0x000ffd67, 0x000fe42c
	, 0x000fd259, 0x000fcaea, 0x000fce8f, 0x000fdbb7, 0x000fef0a, 0x00000437, 0x000016e4, 0x0000238e
	, 0x00002826, 0x00002466, 0x000019b1, 0x00000ab3, 0x000ffabb, 0x000fed07, 0x000fe41f, 0x000fe164
	, 0x000fe4df, 0x000fed60, 0x000ff8d0, 0x000004af, 0x00000e9d, 0x000014ce, 0x0000165a, 0x00001358
	, 0x00000cc1, 0x0000042f, 0x000ffb7b, 0x000ff45a, 0x000ff00d, 0x000fef2a, 0x000ff18c, 0x000ff671
	, 0x000ffca8, 0x000002dd, 0x000007da, 0x00000ac4, 0x00000b3d, 0x00000968, 0x000005d6, 0x00000162
	, 0x000ffcfc, 0x000ff978, 0x000ff76a, 0x000ff70f, 0x000ff84b, 0x000ffab6, 0x000ffdbb, 0x000000b5
	, 0x00000315, 0x00000478, 0x000004b3, 0x000003db, 0x00000231, 0x00000019, 0x000ffdfe, 0x000ffc41
	, 0x000ffb27, 0x000ffad1, 0x000ffb3a, 0x000ffc40, 0x000ffdaa, 0x000fff39, 0x000000af, 0x000001de
	, 0x000002ab, 0x0000030e, 0x0000030f, 0x000002c6, 0x0000024c, 0x000001c0, 0x00000137, 0x000000c2
	, 0x00000069, 0x00000034
};

#define MAX_NHLT_LEN 8000
static uint8_t mtl_nhlt[MAX_NHLT_LEN];

static int get_dmic_blob_from_nhlt(uint32_t *dst, uint32_t *len)
{
	struct nhlt_acpi_table *top;
	struct nhlt_endpoint *ep;
	int i;

	top = (struct nhlt_acpi_table *)&mtl_nhlt[0];
	ep = (struct nhlt_endpoint *)&top->desc[0];

	for (i = 0; i < top->endpoint_count; i++) {
		if (ep->linktype == NHLT_LINK_DMIC) {
			dst = (uint32_t *)ep;
			*len = ep->length;
			return 0;
		}
		ep = (struct nhlt_endpoint *)((uint8_t*)ep + ep->length);
	}

	return -1;
}

int copy_nhlt_blob(uint8_t *blob, size_t size)
{
	if (size > MAX_NHLT_LEN)
		return -ENOMEM;

	memcpy(&mtl_nhlt[0], blob, size);

	return 0;
}

int sof_ipc4_generate_dmic_config(struct snd_sof_dev *sdev, struct sof_ipc4_dai *ipc4_dai,
		struct snd_pcm_hw_params *params,
		int lp_mode)
{
	struct sof_ipc4_module_copier *copier;

	copier = &ipc4_dai->copier;

	/* first try to get dmic blob from nhlt blob, if not found take the static */
	if(get_dmic_blob_from_nhlt(ipc4_dai->copier_config, &copier->gtw_cfg.config_length)) {
		ipc4_dai->copier_config = mtl_2ch_dmic;
		copier->gtw_cfg.config_length = sizeof(mtl_2ch_dmic) >> 2;
	}

	return 0;
}

